---
format: gfm
---

```{r}
library(epiworldR)
library(data.table)
```

## Data preparation

Setting up an empty model for the moment, we will be using the data from the davis county:

```{r}
#| label: loading-data
davis_pop <- fread("data/davis_population.csv")
davis_pop
```

Looking into the data

```{r}
plot(
  davis_pop$agepops,
  x = davis_pop$agelims,
  xlab = "Age groups",
  ylab = "Population counts",
  main = "Davis County Population by Age Groups"
)

N <- sum(davis_pop$agepops)
```

We can take a look at the mixing matrix

```{r}
davis_mixing_matrix <- readRDS("data/davis_mixing_matrix.rds")
image(
  davis_mixing_matrix,
  xlab = "Age groups",
  ylab = "Age groups",
  main = "Davis County Mixing Matrix"
)
```

The image shows a big diagonal in the middle which is expected as school-age individuals will contact mostly with their peers (most of the groups we have are schools). 

## Model creating

Se will be assuming two values

- Incubation period is 2 to 5 days.
- Basic reproductive number will be between 1.5 and 3.

To compute the basic reproductive number, we use the following:

```{r}
R0 <- 2.5
p_transmission <- 0.2
p_recovery <- 1/7
contact_rate <- R0 * p_recovery / p_transmission
```

```{r}
#| label: creating-model
davis_model <- ModelSEIRMixingQuarantine(
  name                         = "Davis county",
  n                            = N,
  prevalence                   = 1/N,
  contact_rate                 = contact_rate,
  transmission_rate            = p_transmission,
  incubation_days              = 3.5,
  recovery_rate                = 1/p_recovery,
  contact_matrix               = davis_mixing_matrix,
  hospitalization_rate         = 0.05,
  hospitalization_period       = 10,
  days_undetected              = 2, 
  quarantine_period            = 14,
  quarantine_willingness       = 1.0,
  isolation_willingness        = 1.0,
  isolation_period             = 7,
  contact_tracing_success_rate = 0.8,
  contact_tracing_days_prior   = 7
)
```

We now start adding some of the entities from the population data:

```{r}
add_entities_from_dataframe(
  model = davis_model,
  entities = davis_pop,
  col_name = "age_labels",
  col_number = "agepops",
  as_proportion = FALSE
)
```

Running the model

```{r}
davis_model |>
  run_multiple(
    ndays = 100,
    nsims = 20,
    seed  = 8812,
    saver = make_saver("outbreak_size", "hospitalizations"),
    nthreads = 2L
  )
```