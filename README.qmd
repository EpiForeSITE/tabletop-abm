---
format: gfm
title: "Tabletop ABM for Davis County, Utah"
---

This repository presents a tabletop agent-based model (ABM) for H5N1 spread in Davis County, Utah. The model utilizes age mixing data to simulate H5N1 transmission dynamics under various intervention scenarios, including isolation, quarantine, and post-exposure prophylaxis (PEP).

This is not a real situation and is intended for educational purposes only.

## Description of the model

The implemented model is a Susceptible Exposed Infectious Hospitalized Recovered (SEIRH) model with mixing and quarantine features. The model features what we call entities, which are subgroups of the population defined by age groups and schools. School-age agents are assigned to schools based on the population data, and the rest of the population is assigned to age groups. The mixing patterns are given by an age-based contact matrix based on the Polymod study.


```mermaid
flowchart LR
    S[Susceptible] --> E[Exposed]
    E --> I[Infected]
    I --> H[Hospitalized]
    H --> R[Recovered]
    I --> R
```

The model features contact tracing, isolation of detected cases, and quarantine of contacts. Detection happens with uncertainty (80% success rate), and agents isolate and move to the quarantine states with certainty (for now). The model also allows for the implementation of post-exposure prophylaxis (PEP) for contacts of detected cases. The PEP is implemented as a baseline tool that reduces the probability of becoming infected and transmitting H5N1.

The quarantine process is as follows:

```mermaid
flowchart LR
    Start((Start)) --> infected{"Already<br>quarantined<br>or isolated?"}
    infected -->|Yes|End((End))
    infected -->|No|Infected{"Infected<br>(infectious)?"}
    Infected -->|Yes|WillToIsolate{"Willing to isolate"}
    Infected -->|No|vax
    WillToIsolate -->|Yes| Isolate((Isolate))
    WillToIsolate -->|No| End
    vax{"Will use PEP"}
    vax -->|Yes|End
    vax -->|No|WillQuarantine
    WillQuarantine{"Willing to<br>Quarantine?"} -->|No|End
    WillQuarantine -->|Yes|Quarantine((Quarantine))
```

## Limitations of the model

The model has various assumptions that may not hold in real-world scenarios: 

1. Like most, this model does not include a behavioral change from the agents' perspective. This is something we cannot predict accurately. For example, parents deciding to send or not their kids to school, or how they might respond to public health messaging.

2. The disease affects equally all age groups, which is not the case for many diseases. This may be important since we are incorporating a component of the population that is school-age, and they may have different susceptibility and infectiousness profiles compared to adults.

3. We are not using real social network data, but rather a contact matrix that gives us the average number of contacts between age groups. This means that we are not capturing the heterogeneity in contact patterns that may exist in the real world. In previous research it has been demonstrated that social networks (clustering) may play an important role in the spread of infectious diseases, and this is not captured in our model.

## Running the model

To execute this model, it is recommended to run it in a high-performance computing environment due to its computational intensity, especially when simulating multiple scenarios. The model is fast, but the Davis county population is large (over 350,000), and running multiple simulations can be time-consuming on a standard personal computer.

The following diagram illustrates the compartments and transitions in the SEIRH model:

```mermaid
flowchart TB

    %% Disease progression states
    subgraph Main[Disease Progression]
        direction TB
        S[Susceptible]
        E[Exposed]
        In[Infected]
        H[Hospitalized]
        R[Recovered]
    end

    S --> E
    E --> In
    In --> H
    H --> R
    In --> R

    %% Quarantine states
    Dh[Detected<br>Hospitalized]
    Qs[Quarantined<br>Susceptible]
    Qe[Quarantined<br>Exposed]
    I[Isolated]
    Ir[Isolated<br>Recovered]

    %% Infected to
    In <==> I
    In --> Ir
    In --> Dh

    %% Isolated to
    I --> R
    I --> Ir
    I --> H
    I --> Dh

    %% Susceptible quarantined
    S <==> Qs

    %% Exposed
    E <==> Qe

    Qe --> I
    Qe --> In

    Dh --> R

    %% Isolated recovered
    Ir --> R
```

## Summary of results

```{r}
#| label: load-data
#| echo: false
#| warning: false
#| message: false
library(data.table)
library(ggplot2)
dat <- fread("scenarios/combined_scenario_results.csv")

# Replacing the TRUE/FALSE with yes/no for better readability
dat[, isolation := ifelse(isolation, "isolation yes", " isolation no")]
dat[, quarantine := ifelse(quarantine, "quarantine yes", "quarantine no")]
dat[, pep := ifelse(pep, "PEP yes", "PEP no")]

dat <- dat[,.(size, R0, isolation, quarantine, pep, p_geq)]

# Sorting and renaming for better readability
setorder(dat, R0, isolation, quarantine, pep)
setnames(dat, "p_geq", "Probability of Outbreak Size >= 10")

dat <- dat[size==10]
dat[, size := NULL]

knitr::kable(
  dat,
  caption = "Summary of the probability of an outbreak size greater than or equal to 10 for each scenario in Davis County."
)

ggplot(dat, aes(x = R0, y = `Probability of Outbreak Size >= 10`)) +
  geom_bar(stat = "identity") +
  facet_wrap(isolation ~ quarantine + pep) +
  labs(
    title = "Probability of an outbreak size greater than or equal to 10 in Davis County",
    subtitle = "Faceted by isolation, quarantine, and PEP scenarios",
    x = "R0",
    y = "Probability of Outbreak Size >= 10"
  ) +
  theme_minimal() 

if (interactive())
  ggsave("summary_plot.png", width = 8, height = 6)
```


## Links to the scenarios

The following table links to the reports generated for each of the scenarios run for Davis County:

```{r}
#| label: listing
#| echo: false
fns <- list.files(path = "scenarios", pattern = "\\.md$", full.names = TRUE)

# Processing the names
scenarios <- data.frame(
  R0 = gsub(".+R0_([0-9.]+)_.*", "\\1", fns),
  Isolation = gsub(".+isolation_([A-Za-z]+)_.*", "\\1", fns),
  Quarantine = gsub(".+quarantine_([A-Za-z]+)(\\.|_).+", "\\1", fns),
  PEP = ifelse(grepl("_pep_yes", fns), "yes", "no"),
  Link = paste0("[View Report](", fns, ")")
)

# Sorting by R0, Isolation, Quarantine
scenarios <- scenarios[
  order(
    as.numeric(scenarios$R0),
    scenarios$Isolation,
    scenarios$Quarantine,
    scenarios$PEP
  ),
]

knitr::kable(
  scenarios,
  caption = "Links to the scenario reports for Davis County",
  row.names = FALSE
)
```

## Software

The simulations used the R package `epiworldR` version `r `packageVersion("epiworldR")``, which can be found at <https://github.com/UofUEpiBio/epiworldR>, and R version `r R.version.string`. 
